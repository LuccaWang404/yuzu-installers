on:
  schedule:
    # check update per 5 minutes (test only)
    - cron: '*/5 * * * *'
    # check update per 12 hours
    # - cron: '0 */12 * * *'

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Get version information
        id: version_info
        # Get latest version information through GitHub API
        run: |
          LATEST_RELEASE=$(curl --silent "https://api.github.com/repos/yuzu-emu/yuzu-mainline/releases/latest" | jq -r .tag_name)
          echo "build_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: Create tag
        uses: actions/github-script@v6
        # Use GitHub Scripts to create a new tag. If there are no newer versions available, this step will fail.
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.version_info.outputs.build_version }}',
              sha: context.sha
            })

  build-and-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check update & Write version information
        # Powershell PS1 Scripts to compare version information. Newer version information will be recorded in yuzu_latest_tag.txt.
        # If there are no newer versions available, this step will fail with exit code 1.
        run: |
          $response = Invoke-RestMethod -Uri "https://api.github.com/repos/yuzu-emu/yuzu-mainline/releases/latest"
          $tag_name = $response.tag_name
          $previous_tag_name = cat yuzu_latest_tag.txt
          if ($tag_name -eq $previous_tag_name) {
            echo No newer version has been found.
            exit 1
          }         
          else {
            echo $tag_name > yuzu_latest_tag.txt
          }
        shell: powershell
      
      - name: Commit version information
        # Commit new version information text file to the repository
        run: |
          git config --global user.name 'LuccaWang404'
          git config --global user.email 'jh327063592@163.com'
          git add yuzu_latest_tag.txt
          git commit -m "Version Update"
        shell: powershell
      
      - name: Push changes
      # Push new version information text file to the repository
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
      
      - name: Save version information to $env
      # Set $env variables
        id: version_info
        run: |
          $response = Invoke-RestMethod -Uri "https://api.github.com/repos/yuzu-emu/yuzu-mainline/releases/latest"
          $tag_name = $response.tag_name
          echo "build_version=$tag_name" >> $env:GITHUB_OUTPUT
          $7zFile = $release.assets | Where-Object { $_.name -like "*.7z" }
          $browser_download_url = $7zFile[0].browser_download_url
          echo "download_url=$browser_download_url" >> $env:GITHUB_OUTPUT
        shell: powershell
      
      - name: Download & extract latest release
      # Download and extract latest release (.7z version)
        run: |
          wget -o yuzu-windows-msvc-latest.7z ${{ steps.version_info.outputs.download_url }}
          7z x yuzu-windows-msvc-latest.7z
        shell: powershell

      - name: Compile .ISS to .EXE Installer
      # Inno Setup compilation
        uses: Minionguyjpro/Inno-Setup-Action@v1.1.0
        with:
          path: yuzu-mainline-0-installer.iss
          options: /O+

      - name: Pushing new release
      # Publish installer
        uses: ncipollo/release-action@v1.10.0
        with:
          name: ${{ steps.version_info.outputs.build_version }}
          artifacts: "build/*.exe"
          tag: ${{ steps.version_info.outputs.build_version }}
          body: "## ğŸ””ğŸŠ æŸšå­æ¨¡æ‹Ÿå™¨å®‰è£…ç¨‹åºå‘è¡Œç‰ˆ( v${{ steps.version_info.outputs.build_version }} )æ›´æ–°ğŸ””
          
                  æ­¤å‘è¡ŒåŒ…å«âš¡ï¸æœ€æ–°çš„âš¡ï¸( v ${{ steps.version_info.outputs.build_version }} )æŸšå­æ¨¡æ‹Ÿå™¨å®‰è£…ç¨‹åºå’Œå®‰è£…ç¨‹åºä»¥[Inno Setup](https://jrsoftware.org/isinfo.php)è„šæœ¬ç¼–å†™çš„æºä»£ç å‹ç¼©å­˜æ¡£ã€‚</br>
                  æ­¤é¡¹ç›®ä¸ºä¸€ä¸ªéå®˜æ–¹çš„[æŸšå­æ¨¡æ‹Ÿå™¨](https://github.com/yuzu-emu/yuzu)å®‰è£…ç¨‹åºæ„å»ºç‰ˆæœ¬ã€‚</br>
                  å¦‚æœæ‚¨éœ€è¦äº†è§£æ›´å¤šç»†èŠ‚ï¼Œè¯·å‰å¾€å®˜æ–¹ä»“åº“çš„å‘å¸ƒé¡µé¢ä»¥æŸ¥çœ‹æœ€æ–°çš„[Changelog](https://github.com/yuzu-emu/yuzu-mainline/releases/latest)ã€‚</br>
                  **â—ï¸ç”±äºæœ¬å®‰è£…ç¨‹åºä»å¤„äºæµ‹è¯•é˜¶æ®µï¼Œæ‰€æœ‰åŠŸèƒ½å‡ä¸ç¨³å®šå¹¶å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œè¯·è°¨æ…ä½¿ç”¨â—ï¸**</br>
                  
                  > TIPï¼šæ­¤é¡¹ç›®é€šè¿‡GitHub Actionså®šæ—¶æ£€æŸ¥æ›´æ–°ã€å³æ—¶æ„å»ºï¼Œä¸å®˜æ–¹æ¸ é“çš„å‘è¡Œè¿›åº¦åŸºæœ¬åŒæ­¥ã€‚</br>"
          omitBodyDuringUpdate: true
          allowUpdates: true
          replacesArtifacts: true
          owner: "LuccaWang404"
          repo: "yuzu-installers"
          token: ${{ secrets.GITHUB_TOKEN }}
      
